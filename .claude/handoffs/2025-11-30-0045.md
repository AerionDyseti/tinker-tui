# Handoff - tinker-ui

**Date:** 2025-11-30 00:45 | **Branch:** master

## Summary

Built a simulation harness for LLM-to-LLM testing to exercise the domain layer without a web UI. Completed the SessionEntry → SessionArtifact refactor. Added integrated mode with dual ActiveSession support for testing both coding and roleplay scenarios.

## Completed

- **SessionArtifact refactor** (commit 5cfc992) — ToolInvocation split into ToolUse + ToolResult, generic `addArtifact<T>` for type-safe creation
- **Simulation harness** — `src/simulation/{config,runner,cli}.ts`, supports Ollama/OpenRouter
- **Retry logic** — Exponential backoff (2s-32s) for 429 rate limits
- **Context logging** — Truncated console output + full JSON dump
- **Integrated mode** — Uses ActiveSession with full domain layer
- **Dual session support** — Both user and agent can have their own sessions (WIP, not tested yet)
- **Developer agent** — `.claude/agents/developer.md` with Serena + Context7 MCP tools
- **Test plan** — `docs/simulation-test-plan.md` with 7 scenarios

## In Progress

- Dual session mode implementation complete but untested (rate limited before we could test)
- `simulations/scenarios/basic-conversation.json` ready to test

## Key Decisions

- **Mistral for user, Llama for agent** — Gemma rejected (no system prompt on free tier)
- **Dual sessions for roleplay** — Both sides need context for non-coding use cases
- **Artifacts structure** — `result.artifacts.agent` and `result.artifacts.user` (optional)

## Insights & Patterns

- TypeScript's `Omit<UnionType, keys>` distributes but doesn't narrow — solution: generic methods `<T extends Union>`
- OpenRouter free tier rate limits aggressively — retry with backoff essential
- ToolUse/ToolResult split improves immutability over mutable ToolInvocation

## Blocked

- None

## Next Steps

1. **Test dual session mode** — Run `bun run simulate simulations/scenarios/basic-conversation.json`
2. **Phase 2: Assertion framework** — `assertArtifactCount`, `assertContextFits`, `assertToolPairComplete`
3. **Phase 3: Scenario library** — More configs in `simulations/scenarios/`
4. **Commit outstanding changes** — Dual session implementation not yet committed

## Working Context

- **Key files:**
  - `src/simulation/runner.ts` — Main simulation logic
  - `src/simulation/config.ts` — Config types
  - `simulations/scenarios/basic-conversation.json` — Test scenario
  - `docs/simulation-test-plan.md` — Full test plan
- **Commands:**
  - `bun run simulate <config.json>` — Run simulation
  - `bun run simulate <config.json> --turns 2` — Override turns
  - `bun run simulate <config.json> --dry-run` — Validate config only
- **Environment:** `OPENROUTER_API_KEY` required for OpenRouter models

## Memory IDs

- `de1b6ae0-4acd-4f76-a2f3-2abadec9ac71` — Simulation harness implementation
- `2fc87802-c36f-4ec8-9078-c638f670f8dc` — Integrated simulation mode
- `b54c70bf-1845-4468-a7a5-267ceef0f8e6` — LLM model selection decision
- `cf3e2bfb-2efa-48e4-9367-51bc404e8752` — Developer agent definition
- `f1036ad1-ef83-4b56-90c9-c896e059357f` — SessionArtifact refactor
- `7114998c-3229-484f-b26e-f451a8f10961` — Simulation test plan roadmap
